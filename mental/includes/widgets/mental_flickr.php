<?php
/**
 * Mental Flickr Widget
 *
 * @author Vedmant <vedmant@gmail.com>
 * @package Mental WP
 * @link http://azelab.com
 */

defined( 'ABSPATH' ) OR exit( 'restricted access' ); // Protect against direct call

/**
 * Class Mental_Widget_Flickr
 */
class Mental_Widget_Flickr extends WP_Widget
{

	function __construct()
	{
		$widget_ops = array( 'classname'   => 'flickr',
		                     'description' => __( 'The most recent photos from flickr.', 'mental' )
		);

		$control_ops = array( 'id_base' => 'flickr-widget' );

		parent::__construct( 'flickr-widget', __( 'Mentas Flickr Stream', 'mental' ), $widget_ops, $control_ops );
	}

	function widget( $args, $instance )
	{

		$title       = apply_filters( 'widget_title', $instance['title'] );
		$screen_name = $instance['screen_name'];
		$number      = $instance['number'];
		$api         = $instance['api'];

		echo $args['before_widget'];

		if ( $title ) {
			echo $args['before_title'] . esc_html($title) . $args['after_title'];
		}

		if ( $screen_name && $number && $api ) {
			?>
			<div class="row wg-flicker">


				<script type="text/javascript">

					function jsonFlickrApi(rsp){
						if(rsp.stat != "ok"){
							// If this executes, something broke!
							return;
						}

						//variable "s" is going to contain
						//all the markup that is generated by the loop below
						var s = "";

						//this loop runs through every item and creates HTML
						for(var i = 0; i < rsp.photos.photo.length; i++){
							photo = rsp.photos.photo[i];

							//notice that "t.jpg" is where you change the
							//size of the image
							t_url = "http://farm" + photo.farm +
							".static.flickr.com/" + photo.server + "/" +
							photo.id + "_" + photo.secret + "_" + "q.jpg";

							p_url = "http://www.flickr.com/photos/" +
							photo.owner + "/" + photo.id;

							s += '<div class="flickr-image col-xs-4 col-md-6 col-lg-4"><a target="_blank" class="img-zoom-hover"  href="' + p_url + '">' + '<img alt="' +
							photo.title + '"src="' + t_url + '"/>' + '</a></div>';
						}

						document.write(s);
					}

					function add_script(url){
						var script = document.createElement("script");
						script.type = "text/javascript"; script.src = url;
						var tmp = document.createElement("div");
						tmp.appendChild(script);
						document.write(tmp.innerHTML);
					}

					add_script('https://api.flickr.com/services/rest/?format=json&method=flickr.photos.search&user_id=<?php echo esc_attr($screen_name); ?>&api_key=<?php echo esc_attr($api); ?>&media=photos&per_page=<?php echo (int) $number; ?>&privacy_filter=1');

					add_script('https://api.flickr.com/services/rest/?format=json&method=flickr.photos.search&group_id=<?php echo esc_attr($screen_name); ?>&api_key=<?php echo esc_attr($api); ?>&media=photos&per_page=<?php echo (int) $number; ?>&privacy_filter=1');

				</script>
			</div>

		<?php
		}

		echo $args['after_widget'];
	}

	function update( $new_instance, $old_instance )
	{
		$instance = $old_instance;

		$instance['title']       = strip_tags( $new_instance['title'] );
		$instance['screen_name'] = $new_instance['screen_name'];
		$instance['number']      = $new_instance['number'];
		$instance['api']         = $new_instance['api'];

		return $instance;
	}

	function form( $instance )
	{
		$defaults = array( 'title'       => 'Flickr Stream',
		                   'screen_name' => '',
		                   'number'      => 6,
		                   'api'         => 'c9d2c2fda03a2ff487cb4769dc0781ea'
		);
		$instance = wp_parse_args( (array) $instance, $defaults ); ?>

		<p>
			<label for="<?php echo esc_attr($this->get_field_id( 'title' )); ?>"><?php _e( 'Title:', 'mental' ) ?></label>
			<input class="widefat" type="text" id="<?php echo esc_attr($this->get_field_id( 'title' )); ?>"
			       name="<?php echo esc_attr($this->get_field_name( 'title' )); ?>" value="<?php echo esc_attr($instance['title']); ?>"/>
		</p>

		<p>
			<label for="<?php echo esc_attr($this->get_field_id( 'screen_name' )); ?>"><?php _e( 'Flickr ID(<a target="_blank" href="http://idgettr.com/">Get
               your flickr ID</a>):', 'mental' ) ?></label>
			<input class="widefat" type="text" id="<?php echo esc_attr($this->get_field_id( 'screen_name' )); ?>"
			       name="<?php echo esc_attr($this->get_field_name( 'screen_name' )); ?>"
			       value="<?php echo esc_attr($instance['screen_name']); ?>"/>
		</p>


		<p>
			<label
				for="<?php echo esc_attr($this->get_field_id( 'number' )); ?>"><?php _e( 'Number of photos to show:', 'mental' ) ?></label>
			<input class="widefat" type="text" style="width: 30px;" id="<?php echo esc_attr($this->get_field_id( 'number' )); ?>"
			       name="<?php echo esc_attr($this->get_field_name( 'number' )); ?>" value="<?php echo esc_attr($instance['number']); ?>"/>
		</p>

		<p>
			<label for="<?php echo esc_attr($this->get_field_id( 'api' )); ?>"><?php _e( 'API key (Use default or get your own from <a
               target="_blank" href="http://www.flickr.com/services/apps/create/apply">Flickr APP Garden</a>):', 'mental' ) ?></label>
			<input class="widefat" type="text" id="<?php echo esc_attr($this->get_field_id( 'api' )); ?>"
			       name="<?php echo esc_attr($this->get_field_name( 'api' )); ?>" value="<?php echo esc_attr($instance['api']); ?>"/>
		</p>

	<?php
	}
}

// Init Widget
add_action( 'widgets_init', create_function( '', 'register_widget( "Mental_Widget_Flickr" );' ) );
